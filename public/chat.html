<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Chat Aste Florio (WhatsApp)</title>
  <style>
    body {
      display: flex;
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f0f2f5;
    }
    .sidebar {
      width: 300px;
      background: #fff;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      height: 100vh;
    }
    .sidebar h2 {
      margin: 0;
      padding: 10px;
      background: #075e54;
      color: white;
    }
    .chat-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .chat-list li {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-list li:hover {
      background: #f6f6f6;
    }
    .chat-list li.active {
      background: #dcf8c6;
    }
    .badge {
      background: #25d366;
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 0.75em;
    }
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .chat-header {
      background: #075e54;
      color: white;
      padding: 10px;
      font-weight: bold;
    }
    .chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #e5ddd5;
    }
    .date-divider {
      text-align: center;
      font-size: 0.8em;
      margin: 10px auto;
      color: #555;
    }
    .message {
      max-width: 60%;
      margin: 5px 0;
      padding: 8px 12px;
      border-radius: 8px;
      clear: both;
      position: relative;
      display: inline-block;
    }
    .inbound {
      background: white;
      float: left;
    }
    .outbound {
      background: #dcf8c6;
      float: right;
    }
    .timestamp {
      font-size: 0.7em;
      color: #555;
      display: block;
      text-align: right;
      margin-top: 4px;
    }
    .chat-input {
      display: flex;
      border-top: 1px solid #ccc;
      padding: 10px;
      background: white;
    }
    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-right: 5px;
    }
    .chat-input button {
      padding: 10px 15px;
      background: #075e54;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Conversazioni</h2>
    <ul class="chat-list" id="chatList"></ul>
  </div>
  <div class="chat-window">
    <div class="chat-header" id="chatHeader">Nessuna chat selezionata</div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="msgInput" placeholder="Scrivi un messaggio..." onkeydown="handleKey(event)">
      <button onclick="sendMessage()">Invia</button>
    </div>
  </div>

  <script>
    let dbUrl = 'https://aste-florio-default-rtdb.europe-west1.firebasedatabase.app/messages.json';
    let messages = {};
    let grouped = {};
    let unread = {};
    let selected = null;

    fetch(dbUrl).then(res => res.json()).then(data => {
      messages = data || {};
      for (let id in messages) {
        const msg = messages[id];
        const from = (msg.from || '').replace('whatsapp:', '');
        const to = (msg.to || '').replace('whatsapp:', '');
        const key = msg.direction === 'inbound' ? from : to;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push({ ...msg, id });
        if (!unread[key]) unread[key] = 0;
        if (msg.direction === 'inbound') unread[key]++;
      }

      const chatList = document.getElementById('chatList');
      chatList.innerHTML = '';
      Object.keys(grouped).sort((a, b) => {
        const lastA = grouped[a].at(-1).timestamp;
        const lastB = grouped[b].at(-1).timestamp;
        return lastB - lastA;
      }).forEach(number => {
        let li = document.createElement('li');
        li.innerHTML = `<span>${number}</span>` + (unread[number] ? `<span class="badge">${unread[number]}</span>` : '');
        li.onclick = () => loadChat(number, li);
        chatList.appendChild(li);
      });
    });

    function formatDate(ts) {
      const d = new Date(ts);
      return d.toLocaleDateString('it-IT');
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
    }

    function loadChat(number, liEl) {
      selected = number;
      document.getElementById('chatHeader').innerText = number;
      document.querySelectorAll('.chat-list li').forEach(li => li.classList.remove('active'));
      liEl.classList.add('active');
      unread[number] = 0;
      liEl.querySelector('.badge')?.remove();

      const chat = grouped[number] || [];
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';

      let lastDate = '';
      chat.sort((a, b) => a.timestamp - b.timestamp).forEach(msg => {
        let d = formatDate(msg.timestamp);
        if (d !== lastDate) {
          const divDate = document.createElement('div');
          divDate.className = 'date-divider';
          divDate.innerText = d;
          chatMessages.appendChild(divDate);
          lastDate = d;
        }

        const div = document.createElement('div');
        div.className = 'message ' + msg.direction;
        div.innerText = msg.body;

        const time = document.createElement('span');
        time.className = 'timestamp';
        time.innerText = formatTime(msg.timestamp);
        div.appendChild(time);

        chatMessages.appendChild(div);
      });

      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function handleKey(e) {
      if (e.key === 'Enter') sendMessage();
    }

    function sendMessage() {
      const body = document.getElementById('msgInput').value.trim();
      if (!body || !selected) return alert('Seleziona una chat e scrivi qualcosa.');
      fetch('/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to: selected, body })
      }).then(res => {
        if (res.ok) {
          document.getElementById('msgInput').value = '';
          const msg = {
            body,
            from: 'me',
            to: selected,
            timestamp: Date.now(),
            direction: 'outbound'
          };
          grouped[selected].push(msg);
          loadChat(selected, document.querySelector('.chat-list li.active'));
        } else alert('Errore invio');
      });
    }
  </script>
</body>
</html>
