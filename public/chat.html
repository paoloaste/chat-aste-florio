<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Chat Aste Florio (WhatsApp)</title>

  <!-- Firebase App (core) + Auth + Database -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js" defer></script>

  <style>
    :root {
      --wa-green-dark: #075e54;
      --wa-green-light: #128c7e;
      --wa-accent: #25d366;
      --wa-bg: #0a1014;
      --wa-chat-bg: #e5ddd5;
      --wa-sidebar-bg: #111b21;
      --wa-input-bg: #202c33;
      --wa-border: #202c33;
      --wa-text-primary: #e9edef;
      --wa-text-secondary: #8696a0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: radial-gradient(circle at top, #182533 0, #05080a 55%);
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--wa-text-primary);
    }

    /* Wrapper principale stile WhatsApp Web */
    .app-shell {
      width: 100%;
      height: 100vh;
      max-width: 1400px;
      max-height: 900px;
      background: #0a1014;
      box-shadow: 0 0 0 1px #202c33, 0 25px 55px rgba(0, 0, 0, 0.7);
      display: flex;
      overflow: hidden;
      border-radius: 8px;
    }

    /* LOGIN */
    #loginBox {
      background: #111b21;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      color: var(--wa-text-primary);
    }

    #loginBox h2 {
      margin-top: 0;
      margin-bottom: 10px;
    }

    #loginBox input {
      background: #202c33;
      border: 1px solid #202c33;
      color: var(--wa-text-primary);
      border-radius: 4px;
    }

    #loginBox button {
      background: var(--wa-green-light);
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    #loginBox button:hover {
      background: var(--wa-green-dark);
    }

    .sidebar, .chat-window {
      display: none; /* verranno mostrati dopo login */
    }

    /* SIDEBAR */
    .sidebar {
      width: 30%;
      min-width: 320px;
      background: var(--wa-sidebar-bg);
      border-right: 1px solid var(--wa-border);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: #202c33;
      border-bottom: 1px solid var(--wa-border);
    }

    .sidebar-header-title {
      font-size: 16px;
      font-weight: 600;
    }

    .sidebar-header-actions button {
      background: transparent;
      border: none;
      color: var(--wa-text-secondary);
      cursor: pointer;
      margin-left: 8px;
      font-size: 18px;
    }

    .sidebar-header-actions button:hover {
      color: var(--wa-text-primary);
    }

    .sidebar-search {
      padding: 8px 12px;
      border-bottom: 1px solid var(--wa-border);
    }

    .sidebar-search input {
      width: 100%;
      padding: 6px 10px;
      border-radius: 16px;
      border: none;
      background: #202c33;
      color: var(--wa-text-primary);
      outline: none;
      font-size: 13px;
    }

    .chat-list {
      list-style: none;
      padding: 0;
      margin: 0;
      overflow-y: auto;
      flex: 1;
    }

    .chat-list::-webkit-scrollbar,
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-list::-webkit-scrollbar-thumb,
    .chat-messages::-webkit-scrollbar-thumb {
      background: #374045;
      border-radius: 3px;
    }

    .chat-list li {
      padding: 10px 16px;
      border-bottom: 1px solid #202c33;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .chat-list li:hover {
      background: #202c33;
    }

    .chat-list li.active {
      background: #202c33;
    }

    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #202c33;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--wa-text-secondary);
      font-size: 18px;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .chat-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .chat-info-top {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .chat-name {
      font-size: 15px;
      font-weight: 500;
      color: var(--wa-text-primary);
    }

    .chat-time {
      font-size: 11px;
      color: var(--wa-text-secondary);
      margin-left: 8px;
      white-space: nowrap;
    }

    .chat-preview-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-preview {
      font-size: 13px;
      color: var(--wa-text-secondary);
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      padding-right: 8px;
    }

    .chat-actions {
      display: flex;
      align-items: center;
    }

    .badge {
      background: var(--wa-accent);
      color: #111b21;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 4px;
      min-width: 18px;
      text-align: center;
    }

    .chat-delete-btn {
      background: transparent;
      border: none;
      color: #8696a0;
      font-size: 16px;
      cursor: pointer;
      margin-left: 6px;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .chat-list li:hover .chat-delete-btn {
      opacity: 1;
    }

    /* CHAT WINDOW */
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      background: url('https://i.imgur.com/tDY6WZJ.png') repeat;
      position: relative;
    }

    .chat-header {
      padding: 10px 16px;
      background: #202c33;
      color: var(--wa-text-primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-left: 1px solid var(--wa-border);
      border-bottom: 1px solid var(--wa-border);
    }

    .chat-header-main {
      display: flex;
      align-items: center;
    }

    .chat-header-info {
      display: flex;
      flex-direction: column;
    }

    .chat-header-name {
      font-weight: 500;
      font-size: 15px;
    }

    .chat-header-status {
      font-size: 12px;
      color: var(--wa-text-secondary);
    }

    .chat-header-actions button {
      background: transparent;
      border: none;
      color: var(--wa-text-secondary);
      cursor: pointer;
      margin-left: 10px;
      font-size: 18px;
    }

    .chat-header-actions button:hover {
      color: var(--wa-text-primary);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px 40px;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top left, rgba(0,0,0,0.3), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(0,0,0,0.6), transparent 55%),
                  url('https://i.imgur.com/tDY6WZJ.png') repeat;
      background-size: auto;
    }

    .date-divider {
      align-self: center;
      margin: 10px 0;
      font-size: 11px;
      color: var(--wa-text-secondary);
      background: #202c33;
      padding: 4px 8px;
      border-radius: 7px;
    }

    .message-row {
      display: flex;
      width: 100%;
      margin-bottom: 4px;
    }

    .message-row.inbound {
      justify-content: flex-start;
    }

    .message-row.outbound {
      justify-content: flex-end;
    }

    .message {
      display: inline-block;
      max-width: 60%;
      margin: 2px 0;
      padding: 6px 8px 4px 9px;
      border-radius: 7.5px;
      position: relative;
      word-break: break-word;
      font-size: 14px;
      line-height: 1.4;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.2);
    }

    .message.inbound {
      background: #202c33;
      color: var(--wa-text-primary);
      border-bottom-left-radius: 0;
    }

    .message.outbound {
      background: #005c4b;
      color: var(--wa-text-primary);
      border-bottom-right-radius: 0;
    }

    .message-text {
      white-space: pre-wrap;
    }

    .message-media img {
      max-width: 240px;
      border-radius: 6px;
      display: block;
      margin-top: 4px;
    }

    .message-media a {
      color: #d1f4cc;
      text-decoration: none;
      font-size: 13px;
    }

    .timestamp {
      font-size: 11px;
      text-align: right;
      color: var(--wa-text-secondary);
      margin-top: 2px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 4px;
    }

    .timestamp .status-icon {
      font-size: 12px;
    }

    /* INPUT BAR */
    .chat-input {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-top: 1px solid var(--wa-border);
      background: var(--wa-input-bg);
      gap: 8px;
    }

    .chat-input button.icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--wa-text-secondary);
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-input button.icon-btn:hover {
      background: #202c33;
      color: var(--wa-text-primary);
    }

    .chat-input input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 8px;
      border: none;
      background: #202c33;
      color: var(--wa-text-primary);
      outline: none;
      font-size: 14px;
    }

    .chat-input input::placeholder {
      color: var(--wa-text-secondary);
    }

    .chat-input button.send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--wa-green-light);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .chat-input button.send-btn:hover {
      background: var(--wa-green-dark);
    }

    /* Placeholder quando nessuna chat √® selezionata */
    .chat-placeholder {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--wa-text-secondary);
      text-align: center;
      padding: 24px;
    }

    .chat-placeholder h2 {
      font-weight: 300;
      margin-bottom: 8px;
    }

    .chat-placeholder p {
      font-size: 14px;
      max-width: 360px;
    }

    @media (max-width: 900px) {
      .app-shell {
        max-width: 100%;
        max-height: 100%;
        border-radius: 0;
      }

      .sidebar {
        width: 35%;
      }

      .chat-messages {
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <div id="loginBox" style="margin:auto; padding:20px; display:flex; flex-direction:column; width:300px; gap:10px;">
    <h2>Login Aste Florio</h2>
    <input type="email" id="email" placeholder="Email" style="padding:8px;">
    <input type="password" id="password" placeholder="Password" style="padding:8px;">
    <button onclick="login()" style="padding:8px;">Accedi</button>
  </div>

  <div class="app-shell" id="appShell" style="display:none;">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-header-title">Conversazioni</div>
        <div class="sidebar-header-actions">
          <button title="Aggiorna" onclick="loadAll()">‚ü≥</button>
          <button title="Esci" onclick="logout()">‚éã</button>
        </div>
      </div>
      <div class="sidebar-search">
        <input type="text" id="searchInput" placeholder="Cerca o avvia una nuova chat" oninput="filterChats()">
        <div style="display:flex; align-items:center; margin-top:6px; gap:6px; font-size:12px; color:var(--wa-text-secondary);">
          <input type="checkbox" id="unreadOnly" onchange="filterChats()" style="margin:0;">
          <label for="unreadOnly">Mostra solo non letti</label>
        </div>
      </div>
      <ul class="chat-list" id="chatList"></ul>
    </div>

    <!-- CHAT WINDOW -->
    <div class="chat-window">
      <div class="chat-header" id="chatHeader">
        <div class="chat-header-main">
          <div class="chat-avatar" id="chatAvatar">?</div>
          <div class="chat-header-info">
            <div class="chat-header-name" id="chatHeaderName">Nessuna chat selezionata</div>
            <div class="chat-header-status" id="chatHeaderStatus">Seleziona una conversazione dalla lista</div>
          </div>
        </div>
        <div class="chat-header-actions">
          <button title="Info contatto">‚Ñπ</button>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-placeholder" id="chatPlaceholder">
          <h2>Benvenuto in Aste Florio Chat</h2>
          <p>Seleziona una conversazione a sinistra per iniziare a vedere e inviare messaggi WhatsApp.</p>
        </div>
      </div>
      <div class="chat-input">
        <button class="icon-btn" title="Emoji">üòä</button>
        <button class="icon-btn" title="Allega">üìé</button>
        <input type="text" id="msgInput" placeholder="Scrivi un messaggio" onkeydown="handleKey(event)">
        <button class="send-btn" onclick="sendMessage()" title="Invia">‚û§</button>
      </div>
    </div>
  </div>

  <script>
    // Carico Firebase solo quando lo script √® pronto
    window.addEventListener('load', () => {
      const firebaseConfig = {
        apiKey: "AIzaSyAtsIoHSxlRXRLRPulOiqIJtuxOWIbZGag",
        authDomain: "aste-florio.firebaseapp.com",
        databaseURL: "https://aste-florio-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "aste-florio",
      };
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
    });

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('appShell').style.display = 'flex';
        loadAll();
      } else {
        document.getElementById('loginBox').style.display = 'flex';
        document.getElementById('appShell').style.display = 'none';
      }
    });

    function login() {
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value.trim();
      firebase.auth().signInWithEmailAndPassword(email, pass)
        .catch(err => alert("Errore login: " + err.message));
    }

    function logout() {
      firebase.auth().signOut();
    }

    let grouped = {}, unread = {}, readStatus = {}, selected = null, lastMessageByChat = {};
    const dbUrl = 'https://aste-florio-default-rtdb.europe-west1.firebasedatabase.app';

    async function loadAll() {
      const user = firebase.auth().currentUser;
      const token = await user.getIdToken();

      const [messages, status] = await Promise.all([
        fetch(`${dbUrl}/messages.json?auth=${token}`).then(r => r.json()),
        fetch(`${dbUrl}/readStatus.json?auth=${token}`).then(r => r.json())
      ]);

      console.log("‚úÖ Dati letti:", messages, status);

      grouped = {}; unread = {}; lastMessageByChat = {}; readStatus = status || {};

      for (let id in messages) {
        const m = messages[id];
        const isInbound = m.direction === 'inbound' || m.from === 'cliente';
        const phone = isInbound
          ? (m.from || '').replace('whatsapp:', '')
          : (m.to || '').replace('whatsapp:', '');
        if (!grouped[phone]) grouped[phone] = [];
        const msgWithId = { ...m, id };
        grouped[phone].push(msgWithId);
        lastMessageByChat[phone] = msgWithId;
        m.direction = m.direction || (m.from === "azienda" ? "outbound" : "inbound");
      }

      for (let phone in grouped) {
        const lastRead = readStatus[phone] || 0;
        unread[phone] = grouped[phone].filter(m => m.direction === 'inbound' && m.timestamp > lastRead).length;
      }

      renderSidebar();
    }

    function renderSidebar() {
      const ul = document.getElementById('chatList');
      ul.innerHTML = '';
      Object.keys(grouped).sort((a, b) => {
        const aT = (lastMessageByChat[a] || grouped[a].at(-1)).timestamp;
        const bT = (lastMessageByChat[b] || grouped[b].at(-1)).timestamp;
        return bT - aT;
      }).forEach(num => {
        const lastMsg = lastMessageByChat[num] || grouped[num].at(-1);
        const li = document.createElement('li');

        const initials = num.replace('whatsapp:', '').slice(-2).toUpperCase();
        const previewText = (lastMsg.body || lastMsg.text || '[media]').replace(/\n/g, ' ');

        li.innerHTML = `
          <div class="chat-avatar">${initials}</div>
          <div class="chat-info">
            <div class="chat-info-top">
              <span class="chat-name">${num}</span>
              <span class="chat-time">${formatTime(lastMsg.timestamp)}</span>
            </div>
            <div class="chat-preview-row">
              <span class="chat-preview">${previewText}</span>
              <div class="chat-actions">
                ${unread[num] ? `<span class="badge">${unread[num]}</span>` : ''}
                <button class="chat-delete-btn" onclick="deleteChat('${num}')">‚úï</button>
              </div>
            </div>
          </div>
        `;

        li.onclick = (e) => {
          if (!(e.target && (e.target.classList.contains('chat-delete-btn')))) {
            loadChat(num, li);
          }
        };
        ul.appendChild(li);
      });
    }

    function formatDate(ts) {
      return new Date(ts).toLocaleDateString('it-IT');
    }

    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
    }

    async function loadChat(number, li) {
      selected = number;
      document.querySelectorAll('.chat-list li').forEach(l => l.classList.remove('active'));
      li.classList.add('active');

      const avatar = document.getElementById('chatAvatar');
      const headerName = document.getElementById('chatHeaderName');
      const headerStatus = document.getElementById('chatHeaderStatus');

      avatar.textContent = number.replace('whatsapp:', '').slice(-2).toUpperCase();
      headerName.textContent = number;
      headerStatus.textContent = 'Online';

      // aggiorna stato lettura
      fetch('/read', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ number })
      });

      unread[number] = 0;
      li.querySelector('.badge')?.remove();

      const box = document.getElementById('chatMessages');
      box.innerHTML = '';
      document.getElementById('chatPlaceholder').style.display = 'none';
      const sorted = grouped[number].sort((a, b) => a.timestamp - b.timestamp);

      // Aggiungi il caricamento degli status
      const statuses = await loadStatuses();

      let lastDate = '';

      sorted.forEach(m => {
        const d = formatDate(m.timestamp);
        if (d !== lastDate) {
          const divDate = document.createElement('div');
          divDate.className = 'date-divider';
          divDate.innerText = d;
          box.appendChild(divDate);
          lastDate = d;
        }
  const row = document.createElement('div');
  row.className = 'message-row ' + m.direction;

  const div = document.createElement('div');
  div.className = 'message ' + m.direction;

        const messageSid = m.sid || (m.params && m.params.sid);
        let latest = null;
  let statusHtml = '';

        if (m.direction === 'outbound' && messageSid && statuses) {
          for (let key in statuses) {
            const s = statuses[key];
            if (s.sid === messageSid) {
              if (!latest || s.timestamp > latest.timestamp) {
                latest = s;
              }
            }
          }

          if (latest) {
            if (latest.status === 'read') statusHtml = '‚úî‚úî';
            else if (latest.status === 'delivered') statusHtml = '‚úî‚úî';
            else if (latest.status === 'sent') statusHtml = '‚úî‚úî';
            else if (latest.status === 'queued') statusHtml = '‚úî';
            else if (latest.status === 'failed' || latest.status === 'undelivered') {
              statusHtml = '‚ùå';
            } else {
              statusHtml = '';
            }
          }
        }

        const textDiv = document.createElement('div');
        textDiv.className = 'message-text';
        if (m.body) {
          textDiv.innerHTML = m.body.replace(/\n/g, "<br>");
        } else if (m.text) {
          textDiv.textContent = m.text;
        } else if (m.params && Array.isArray(m.params)) {
          textDiv.textContent = `[${m.template}] ` + m.params.join(" / ");
        }
        div.appendChild(textDiv);

        if (m.media && Array.isArray(m.media)) {
          const mediaContainer = document.createElement('div');
          mediaContainer.className = 'message-media';
          m.media.forEach(media => {
            if (media.type && media.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = media.url;
              mediaContainer.appendChild(img);
            } else {
              const a = document.createElement('a');
              const fileName = media.url.split('/').pop().split('?')[0];
              a.href = media.url;
              a.target = '_blank';
              a.textContent = `üìé ${fileName}`;
              mediaContainer.appendChild(a);
            }
          });
          div.appendChild(mediaContainer);
        }

        const tsDiv = document.createElement('div');
        tsDiv.className = 'timestamp';
        const timeSpan = document.createElement('span');
        timeSpan.textContent = formatTime(m.timestamp);
        tsDiv.appendChild(timeSpan);

        if (statusHtml) {
          const statusSpan = document.createElement('span');
          statusSpan.className = 'status-icon';
          statusSpan.innerHTML = statusHtml;
          tsDiv.appendChild(statusSpan);
        }

        div.appendChild(tsDiv);
        row.appendChild(div);
        box.appendChild(row);
      });

      box.scrollTop = box.scrollHeight;
    }

    function handleKey(e) {
      if (e.key === 'Enter') sendMessage();
    }

    function sendMessage() {
      const input = document.getElementById('msgInput');
      const body = input.value.trim();
      const fileInput = document.getElementById('fileInput');
      const hasFiles = fileInput && fileInput.files && fileInput.files.length > 0;
      if (!selected || (!body && !hasFiles)) return;
      fetch('/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ to: selected, body })
      }).then(res => {
        if (res.ok) {
          input.value = '';
          if (fileInput) fileInput.value = '';
          const msg = {
            from: 'me',
            to: selected,
            direction: 'outbound',
            timestamp: Date.now(),
            body
          };
          grouped[selected].push(msg);
          lastMessageByChat[selected] = msg;
          loadChat(selected, document.querySelector('.chat-list li.active'));
        }
      });
    }

    function handleFileChange(e) {
      const files = e.target.files;
      if (!files || !files.length) return;
      // Qui potresti mostrare un piccolo riepilogo dei file selezionati
      // e, lato server, estendere /send per supportare upload/media.
    }


    function filterChats() {
      const term = document.getElementById('searchInput').value.toLowerCase();
      const items = document.querySelectorAll('#chatList li');
      items.forEach(li => {
        const nameEl = li.querySelector('.chat-name');
        const previewEl = li.querySelector('.chat-preview');
        const text = ((nameEl && nameEl.textContent) + ' ' + (previewEl && previewEl.textContent)).toLowerCase();
        li.style.display = text.includes(term) ? '' : 'none';
      });
    }

    // üîÑ Carica gli status da Firebase
    async function loadStatuses() {
      const user = firebase.auth().currentUser;
      if (!user) return {};
      const token = await user.getIdToken();

      const res = await fetch(`${dbUrl}/logs/status.json?auth=${token}`);
      return await res.json() || {};
    }

    // loadAll(); // Commentata per evitare il caricamento prima dell'autenticazione

    function deleteChat(number) {
      if (!confirm(`Sei sicuro di voler cancellare la chat con ${number}?`)) return;

      fetch('/delete-chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ number })
      })
      .then(res => {
        if (res.ok) {
          alert('Chat cancellata con successo');
          loadAll(); // ricarica la sidebar aggiornata
        } else {
          alert('Errore durante la cancellazione della chat');
        }
      });
    }
  </script>
</body>
</html>
