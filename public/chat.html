<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Chat Aste Florio (WhatsApp)</title>

  <!-- Firebase App (core) + Auth + Database -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    :root {
      --wa-green-dark: #075e54;
      --wa-green-light: #128c7e;
      --wa-accent: #25d366;
      --wa-bg: #0a1014;
      --wa-chat-bg: #e5ddd5;
      --wa-sidebar-bg: #111b21;
      --wa-input-bg: #202c33;
      --wa-border: #202c33;
      --wa-text-primary: #e9edef;
      --wa-text-secondary: #8696a0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: radial-gradient(circle at top, #182533 0, #05080a 55%);
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--wa-text-primary);
    }

    /* Wrapper principale stile WhatsApp Web */
    .app-shell {
      width: 100%;
      height: 100vh;
      max-width: 1400px;
      max-height: 900px;
      background: #0a1014;
      box-shadow: 0 0 0 1px #202c33, 0 25px 55px rgba(0, 0, 0, 0.7);
      display: flex;
      overflow: hidden;
      border-radius: 8px;
    }

    /* LOGIN */
    #loginBox {
      background: #111b21;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      color: var(--wa-text-primary);
    }

    #loginBox h2 {
      margin-top: 0;
      margin-bottom: 10px;
    }

    #loginBox input {
      background: #202c33;
      border: 1px solid #202c33;
      color: var(--wa-text-primary);
      border-radius: 4px;
    }

    #loginBox button {
      background: var(--wa-green-light);
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    #loginBox button:hover {
      background: var(--wa-green-dark);
    }

    .sidebar, .chat-window {
      display: none; /* verranno mostrati dopo login */
    }

    /* SIDEBAR */
    .sidebar {
      width: 30%;
      min-width: 320px;
      background: var(--wa-sidebar-bg);
      border-right: 1px solid var(--wa-border);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: #202c33;
      border-bottom: 1px solid var(--wa-border);
    }

    .sidebar-header-title {
      font-size: 16px;
      font-weight: 600;
    }

    .sidebar-header-actions button {
      background: transparent;
      border: none;
      color: var(--wa-text-secondary);
      cursor: pointer;
      margin-left: 8px;
      font-size: 18px;
    }

    .sidebar-header-actions button:hover {
      color: var(--wa-text-primary);
    }

    .sidebar-search {
      padding: 8px 12px;
      border-bottom: 1px solid var(--wa-border);
    }

    .sidebar-search input {
      width: 100%;
      padding: 6px 10px;
      border-radius: 16px;
      border: none;
      background: #202c33;
      color: var(--wa-text-primary);
      outline: none;
      font-size: 13px;
    }

    .sidebar-filter {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--wa-text-secondary);
      margin-top: 6px;
    }

    .sidebar-filter label {
      cursor: pointer;
      user-select: none;
    }

    .chat-list {
      list-style: none;
      padding: 0;
      margin: 0;
      overflow-y: auto;
      flex: 1;
    }

    .chat-list::-webkit-scrollbar,
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-list::-webkit-scrollbar-thumb,
    .chat-messages::-webkit-scrollbar-thumb {
      background: #374045;
      border-radius: 3px;
    }

    .chat-list li {
      padding: 10px 16px;
      border-bottom: 1px solid #202c33;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .chat-list li:hover {
      background: #202c33;
    }

    .chat-list li.active {
      background: #202c33;
    }

    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #202c33;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--wa-text-secondary);
      font-size: 18px;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .chat-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .chat-info-top {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .chat-name {
      font-size: 15px;
      font-weight: 500;
      color: var(--wa-text-primary);
    }

    .chat-time {
      font-size: 11px;
      color: var(--wa-text-secondary);
      margin-left: 8px;
      white-space: nowrap;
    }

    .chat-preview-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-preview {
      font-size: 13px;
      color: var(--wa-text-secondary);
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      padding-right: 8px;
    }

    .chat-actions {
      display: flex;
      align-items: center;
    }

      .chat-action-btn {
        background: transparent;
        border: none;
        color: #8696a0;
        font-size: 16px;
        cursor: pointer;
        margin-left: 6px;
        opacity: 0;
        transition: opacity 0.15s ease;
      }

      .chat-list li:hover .chat-action-btn {
        opacity: 1;
      }

    .badge {
      background: var(--wa-accent);
      color: #111b21;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 4px;
      min-width: 18px;
      text-align: center;
    }

    /* CHAT WINDOW */
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      background: #0a1014;
      position: relative;
    }

    .chat-header {
      padding: 10px 16px;
      background: #202c33;
      color: var(--wa-text-primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-left: 1px solid var(--wa-border);
      border-bottom: 1px solid var(--wa-border);
    }

    .chat-header-main {
      display: flex;
      align-items: center;
    }

    .chat-header-info {
      display: flex;
      flex-direction: column;
    }

    .chat-header-name {
      font-weight: 500;
      font-size: 15px;
    }

    .chat-header-status {
      font-size: 12px;
      color: var(--wa-text-secondary);
    }

    .chat-header-actions button {
      background: transparent;
      border: none;
      color: var(--wa-text-secondary);
      cursor: pointer;
      margin-left: 10px;
      font-size: 18px;
    }

    .chat-header-actions button:hover {
      color: var(--wa-text-primary);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px 40px;
      display: flex;
      flex-direction: column;
      background: #0a1014;
    }

    .date-divider {
      align-self: center;
      margin: 10px 0;
      font-size: 11px;
      color: var(--wa-text-secondary);
      background: #202c33;
      padding: 4px 8px;
      border-radius: 7px;
    }

    .message-row {
      display: flex;
      width: 100%;
      margin-bottom: 4px;
    }

    .message-row.inbound {
      justify-content: flex-start;
    }

    .message-row.outbound {
      justify-content: flex-end;
    }

    .message {
      display: inline-block;
      max-width: 60%;
      margin: 2px 0;
      padding: 6px 8px 4px 9px;
      border-radius: 7.5px;
      position: relative;
      word-break: break-word;
      font-size: 14px;
      line-height: 1.4;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.2);
    }

    .message.inbound {
      background: #202c33;
      color: var(--wa-text-primary);
      border-bottom-left-radius: 0;
    }

    .message.outbound {
      background: #005c4b;
      color: var(--wa-text-primary);
      border-bottom-right-radius: 0;
    }

    .message-text {
      white-space: pre-wrap;
    }

    .message-media img {
      max-width: 240px;
      border-radius: 6px;
      display: block;
      margin-top: 4px;
    }

    .message-media a {
      color: #d1f4cc;
      text-decoration: none;
      font-size: 13px;
    }

    .timestamp {
      font-size: 11px;
      text-align: right;
      color: var(--wa-text-secondary);
      margin-top: 2px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 4px;
    }

    .timestamp .status-icon {
      font-size: 12px;
    }

    /* INPUT BAR */
    .chat-input {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-top: 1px solid var(--wa-border);
      background: var(--wa-input-bg);
      gap: 8px;
      position: relative;
    }

    .chat-input button.icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--wa-text-secondary);
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-input button.icon-btn:hover {
      background: #202c33;
      color: var(--wa-text-primary);
    }

    .chat-input input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 8px;
      border: none;
      background: #202c33;
      color: var(--wa-text-primary);
      outline: none;
      font-size: 14px;
    }

    .chat-input input::placeholder {
      color: var(--wa-text-secondary);
    }

    .chat-input button.send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--wa-green-light);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .chat-input button.send-btn:hover {
      background: var(--wa-green-dark);
    }

    .emoji-picker {
      position: absolute;
      bottom: 56px;
      left: 8px;
      padding: 8px;
      background: #111b21;
      border: 1px solid #202c33;
      border-radius: 8px;
      display: grid;
      grid-template-columns: repeat(5, 28px);
      gap: 6px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
      z-index: 5;
    }

    .emoji-picker button {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 4px;
      background: transparent;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
    }

    .emoji-picker button:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    /* Placeholder quando nessuna chat √® selezionata */
    .chat-placeholder {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--wa-text-secondary);
      text-align: center;
      padding: 24px;
    }

    .chat-placeholder h2 {
      font-weight: 300;
      margin-bottom: 8px;
    }

    .chat-placeholder p {
      font-size: 14px;
      max-width: 360px;
    }

    @media (max-width: 900px) {
      .app-shell {
        max-width: 100%;
        max-height: 100%;
        border-radius: 0;
      }

      .sidebar {
        width: 35%;
      }

      .chat-messages {
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <div id="loginBox" style="margin:auto; padding:20px; display:flex; flex-direction:column; width:320px; gap:10px;">
    <h2>Login Aste Florio</h2>
    <input type="email" id="email" placeholder="Email" style="padding:8px;">
    <input type="password" id="password" placeholder="Password" style="padding:8px;">
    <div id="loginError" style="display:none; font-size:12px; color:#ff6b6b;"></div>
    <button onclick="login()" style="padding:8px;">Accedi</button>
  </div>

  <div class="app-shell" id="appShell" style="display:none;">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-header-title">Conversazioni</div>
        <div class="sidebar-header-actions">
          <button title="Aggiorna" onclick="loadAll()">‚ü≥</button>
          <button title="Esci" onclick="logout()">‚éã</button>
        </div>
      </div>
      <div class="sidebar-search">
        <input type="text" id="searchInput" placeholder="Cerca o avvia una nuova chat" oninput="filterChats()">
        <div class="sidebar-filter">
          <input type="checkbox" id="unreadOnly" onchange="handleUnreadToggle()" style="margin:0;">
          <label for="unreadOnly">Mostra solo non letti</label>
        </div>
      </div>
      <ul class="chat-list" id="chatList"></ul>
    </div>

    <!-- CHAT WINDOW -->
    <div class="chat-window">
      <div class="chat-header" id="chatHeader">
        <div class="chat-header-main">
          <div class="chat-avatar" id="chatAvatar">?</div>
          <div class="chat-header-info">
            <div class="chat-header-name" id="chatHeaderName">Nessuna chat selezionata</div>
            <div class="chat-header-status" id="chatHeaderStatus">Seleziona una conversazione dalla lista</div>
          </div>
        </div>
        <div class="chat-header-actions">
          <button title="Info contatto">‚Ñπ</button>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-placeholder" id="chatPlaceholder">
          <h2>Benvenuto in Aste Florio Chat</h2>
          <p>Seleziona una conversazione a sinistra per iniziare a vedere e inviare messaggi WhatsApp.</p>
        </div>
      </div>
      <div class="chat-input" id="chatInputBar">
        <button class="icon-btn" title="Emoji" id="emojiBtn" onclick="toggleEmojiPicker(event)">üòä</button>
        <button class="icon-btn" title="Allega">üìé</button>
        <input type="text" id="msgInput" placeholder="Scrivi un messaggio" onkeydown="handleKey(event)">
        <button class="send-btn" onclick="sendMessage()" title="Invia">‚û§</button>
        <div class="emoji-picker" id="emojiPicker" style="display:none;"></div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAtsIoHSxlRXRLRPulOiqIJtuxOWIbZGag",
      authDomain: "aste-florio.firebaseapp.com",
      databaseURL: "https://aste-florio-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "aste-florio"
    };
    firebase.initializeApp(firebaseConfig);
    const loginBox = document.getElementById('loginBox');
    const appShell = document.getElementById('appShell');

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        toggleAuthView(true);
        loadAll();
        startRealtimeUpdates();
      } else {
        stopRealtimeUpdates();
        toggleAuthView(false);
      }
    });

    function toggleAuthView(authenticated) {
      if (authenticated) {
        loginBox.style.display = 'none';
        appShell.style.display = 'flex';
      } else {
        loginBox.style.display = 'flex';
        appShell.style.display = 'none';
        selectedConv = null;
        messagesByConv = {};
        conversationStatuses = {};
      }
    }

    function login() {
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value.trim();
      const errorBox = document.getElementById('loginError');
      errorBox.style.display = 'none';
      errorBox.textContent = '';

      if (!email || !pass) {
        errorBox.textContent = 'Inserisci email e password.';
        errorBox.style.display = 'block';
        return;
      }

      firebase.auth().signInWithEmailAndPassword(email, pass)
        .catch(err => {
          console.error('Errore login Firebase:', err);
          let msg = 'Login non riuscito. Controlla le credenziali.';
          if (err.code === 'auth/invalid-email') msg = 'Email non valida.';
          else if (err.code === 'auth/user-not-found') msg = 'Utente non trovato.';
          else if (err.code === 'auth/wrong-password') msg = 'Password errata.';
          else if (err.code === 'auth/network-request-failed') msg = 'Problema di rete. Riprova.';
          errorBox.textContent = msg;
          errorBox.style.display = 'block';
        });
    }

    function logout() {
      firebase.auth().signOut();
    }

    let conversations = {};
    let messagesByConv = {};
    let conversationStatuses = {};
    let selectedConv = null;
    let conversationsPageSize = 50;
    let eventSource = null;
    let pollingTimer = null;
    let sidebarRenderPending = false;
    let loadAllAbortController = null;
    const searchState = {
      term: '',
      resultIds: [],
      lastRequestId: 0,
      debounce: null
    };
    const POLLING_INTERVAL_MS = 12000;
    const DAY_MS = 24 * 60 * 60 * 1000;
    const WEEKDAY_LABELS = ['domenica', 'luned√¨', 'marted√¨', 'mercoled√¨', 'gioved√¨', 'venerd√¨', 'sabato'];
    const EMOJI_SET = ['üòä','üòÇ','üòç','üôè','üëç','üòÖ','üò¢','üéâ','‚ù§Ô∏è','üî•','ü§î','üòé','üôå','üëè','ü§ó'];
    let emojiPickerReady = false;

    async function loadAll() {
      let controller;
      try {
        if (loadAllAbortController) {
          loadAllAbortController.abort();
        }
        controller = new AbortController();
        loadAllAbortController = controller;
        const res = await fetch('/conversations', { signal: controller.signal });
        const list = await res.json();

        conversations = {};
        if (Array.isArray(list)) {
          list.forEach(conv => {
            if (conv && conv.id) {
              conversations[conv.id] = conv;
            }
          });
        }

        conversationsPageSize = 50;
        renderSidebar();
        if (searchState.term) {
          runSearch(searchState.term);
        }
      } catch (err) {
        if (err.name === 'AbortError') return;
        console.error('Errore caricando le conversazioni:', err);
      } finally {
        if (loadAllAbortController === controller) {
          loadAllAbortController = null;
        }
      }
    }

    function renderSidebar(forceImmediate = false) {
      if (forceImmediate) {
        sidebarRenderPending = false;
        renderSidebarInternal();
        return;
      }

      if (sidebarRenderPending) return;
      sidebarRenderPending = true;
      requestAnimationFrame(() => {
        sidebarRenderPending = false;
        renderSidebarInternal();
      });
    }

    function renderSidebarInternal() {
      const ul = document.getElementById('chatList');
      if (!ul) return;
      ul.innerHTML = '';
      const unreadOnly = document.getElementById('unreadOnly')?.checked;
      let ids;

      if (searchState.term) {
        ids = searchState.resultIds.slice();
      } else {
        ids = Object.keys(conversations || {});
        ids.sort((a, b) => {
          const aConv = conversations[a] || {};
          const bConv = conversations[b] || {};
          const aT = aConv.lastMessageAt || 0;
          const bT = bConv.lastMessageAt || 0;
          return bT - aT;
        });
        ids = ids.slice(0, conversationsPageSize);
      }

      if (unreadOnly) {
        ids = ids.filter(id => (conversations[id]?.unreadCount || 0) > 0);
      }

      if (!ids.length) {
        const empty = document.createElement('li');
        empty.style.padding = '16px';
        empty.style.color = '#8696a0';
        empty.style.textAlign = 'center';
        empty.style.pointerEvents = 'none';
        empty.textContent = searchState.term ? 'Nessuna conversazione trovata' : 'Nessuna conversazione';
        ul.appendChild(empty);
        return;
      }

      ids.forEach(id => {
        const conv = conversations[id] || {};
        const num = conv.phone || id;
        const lastMsgText = conv.lastMessageText || '';
        const timestamp = conv.lastMessageAt || 0;
        const li = document.createElement('li');
        li.dataset.conversationId = id;

        const initials = num.replace('whatsapp:', '').slice(-2).toUpperCase();
        const previewText = (lastMsgText || '[media]').replace(/\n/g, ' ');

        li.innerHTML = `
          <div class="chat-avatar">${initials}</div>
          <div class="chat-info">
            <div class="chat-info-top">
              <span class="chat-name">${num}</span>
                <span class="chat-time">${timestamp ? formatSidebarTimestamp(timestamp) : ''}</span>
            </div>
            <div class="chat-preview-row">
              <span class="chat-preview">${previewText}</span>
              <div class="chat-actions">
                ${conv.unreadCount ? `<span class="badge">${conv.unreadCount}</span>` : ''}
                <button class="chat-action-btn" title="Segna come da leggere" onclick="markUnread('${id}', event)">üëÅ</button>
              </div>
            </div>
          </div>
        `;

        li.onclick = (e) => {
          if (e.target && e.target.closest('.chat-action-btn')) return;
          loadChat(id, li);
        };

        if (id === selectedConv) {
          li.classList.add('active');
        }

        ul.appendChild(li);
      });
    }
    function formatDate(ts) {
      return new Date(ts).toLocaleDateString('it-IT');
    }

    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
    }

    function initEmojiPicker() {
      if (emojiPickerReady) return;
      const picker = document.getElementById('emojiPicker');
      if (!picker) return;
      picker.innerHTML = '';
      EMOJI_SET.forEach(emoji => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = emoji;
        btn.onclick = () => insertEmoji(emoji);
        picker.appendChild(btn);
      });
      emojiPickerReady = true;
    }

    function toggleEmojiPicker(event) {
      if (event) event.preventDefault();
      const picker = document.getElementById('emojiPicker');
      if (!picker) return;
      initEmojiPicker();
      const isVisible = picker.style.display !== 'none';
      picker.style.display = isVisible ? 'none' : 'grid';
      document.removeEventListener('click', handleEmojiOutsideClick);
      if (!isVisible) {
        setTimeout(() => document.addEventListener('click', handleEmojiOutsideClick));
      }
    }

    function handleEmojiOutsideClick(event) {
      const picker = document.getElementById('emojiPicker');
      const btn = document.getElementById('emojiBtn');
      if (!picker || picker.style.display === 'none') return;
      if (picker.contains(event.target) || (btn && btn.contains(event.target))) return;
      picker.style.display = 'none';
      document.removeEventListener('click', handleEmojiOutsideClick);
    }

    function insertEmoji(emoji) {
      const input = document.getElementById('msgInput');
      if (!input) return;
      const start = input.selectionStart ?? input.value.length;
      const end = input.selectionEnd ?? input.value.length;
      input.value = input.value.slice(0, start) + emoji + input.value.slice(end);
      const newCaret = start + emoji.length;
      input.focus();
      if (typeof input.setSelectionRange === 'function') {
        input.setSelectionRange(newCaret, newCaret);
      }
    }

    function startOfDay(ts) {
      const date = new Date(ts);
      date.setHours(0, 0, 0, 0);
      return date.getTime();
    }

    function daysDiffFromToday(ts) {
      if (!ts) return 0;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      return Math.round((today.getTime() - startOfDay(ts)) / DAY_MS);
    }

    function formatSidebarTimestamp(ts) {
      if (!ts) return '';
      const diff = daysDiffFromToday(ts);
      if (diff <= 0) return formatTime(ts);
      if (diff === 1) return 'ieri';
      if (diff <= 6) {
        const date = new Date(ts);
        return WEEKDAY_LABELS[date.getDay()];
      }
      return new Date(ts).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
    }

    function normalizeDirection(dir) {
      const value = (dir || '').toString().toLowerCase();
      if (value.startsWith('out')) return 'outbound';
      if (value.startsWith('in')) return 'inbound';
      if (value === 'sent') return 'outbound';
      if (value === 'received') return 'inbound';
      return 'inbound';
    }

    function normalizeMessage(raw) {
      if (!raw) return null;
      const clone = { ...raw };
      clone.direction = normalizeDirection(clone.direction);
      if (!clone.timestamp) clone.timestamp = Date.now();
      if (!clone.text && clone.body) clone.text = clone.body;
      return clone;
    }

    function getStatusIcon(entry) {
      if (!entry || !entry.status) return '';
      const status = entry.status.toLowerCase();
      if (status === 'read' || status === 'delivered' || status === 'sent') return '‚úî‚úî';
      if (status === 'queued') return '‚úî';
      if (status === 'failed' || status === 'undelivered') return '‚ùå';
      return '';
    }

    async function loadChat(conversationId, li) {
      selectedConv = conversationId;
      document.querySelectorAll('.chat-list li').forEach(l => l.classList.remove('active'));

      let targetLi = li || document.querySelector(`.chat-list li[data-conversation-id="${conversationId}"]`);
      if (targetLi) {
        targetLi.classList.add('active');
        targetLi.querySelector('.badge')?.remove();
      }

      const avatar = document.getElementById('chatAvatar');
      const headerName = document.getElementById('chatHeaderName');
      const headerStatus = document.getElementById('chatHeaderStatus');

      const conv = conversations[conversationId] || {};
      const number = conv.phone || conversationId;

      avatar.textContent = number.replace('whatsapp:', '').slice(-2).toUpperCase();
      headerName.textContent = number;
      headerStatus.textContent = 'Online';

      fetch('/read', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ conversationId })
      }).catch(err => console.warn('Errore /read:', err));
      if (conversations[conversationId]) {
        conversations[conversationId].unreadCount = 0;
      }

      const placeholder = document.getElementById('chatPlaceholder');
      if (placeholder) placeholder.style.display = 'none';

      try {
        await ensureMessagesLoaded(conversationId);
        await fetchConversationStatuses(conversationId);
        renderConversation(conversationId);
      } catch (err) {
        console.error('Errore caricando la chat', err);
      }
    }

    async function ensureMessagesLoaded(conversationId) {
      if (messagesByConv[conversationId]) return messagesByConv[conversationId];
      const res = await fetch(`/conversation-messages?id=${encodeURIComponent(conversationId)}`);
      const data = await res.json();
      const arr = [];
      if (Array.isArray(data)) {
        data.forEach(msg => {
          const normalized = normalizeMessage(msg);
          if (normalized) arr.push(normalized);
        });
      }
      arr.sort((a, b) => a.timestamp - b.timestamp);
      messagesByConv[conversationId] = arr.slice(-500);
      return messagesByConv[conversationId];
    }

    async function fetchConversationStatuses(conversationId) {
      try {
        const res = await fetch(`/message-status?conversationId=${encodeURIComponent(conversationId)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        conversationStatuses[conversationId] = data || {};
      } catch (err) {
        console.warn('Errore caricando gli status della conversazione', err);
        conversationStatuses[conversationId] = conversationStatuses[conversationId] || {};
      }
    }

    function renderConversation(conversationId) {
      const box = document.getElementById('chatMessages');
      if (!box) return;
      box.innerHTML = '';

      const sorted = (messagesByConv[conversationId] || []).slice(-500);
      const statuses = conversationStatuses[conversationId] || {};

      let lastDate = '';

      sorted.forEach(m => {
        m.direction = normalizeDirection(m.direction);
        const d = formatDate(m.timestamp);
        if (d !== lastDate) {
          const divDate = document.createElement('div');
          divDate.className = 'date-divider';
          divDate.innerText = d;
          box.appendChild(divDate);
          lastDate = d;
        }

        const row = document.createElement('div');
        row.className = 'message-row ' + m.direction;

        const div = document.createElement('div');
        div.className = 'message ' + m.direction;

        const messageSid = m.sid || (m.params && m.params.sid);
        let statusHtml = '';
        if (m.direction === 'outbound' && messageSid && statuses[messageSid]) {
          statusHtml = getStatusIcon(statuses[messageSid]);
        }

        const textDiv = document.createElement('div');
        textDiv.className = 'message-text';
        let textContent = '';
        if (m.body) textContent = m.body;
        else if (m.text) textContent = m.text;
        else if (m.params && Array.isArray(m.params)) {
          textContent = `[${m.template}] ` + m.params.join(' / ');
        }

        if (m.media && Array.isArray(m.media) && m.media.length) {
          textContent = textContent && textContent !== '[media]' ? textContent : '';
        }

        textDiv.textContent = textContent;
        div.appendChild(textDiv);

        if (Array.isArray(m.media) && m.media.length) {
          const mediaWrapper = document.createElement('div');
          mediaWrapper.className = 'message-media';
          m.media.forEach(item => {
            const mediaUrl = item.proxyUrl || item.url || item.originalUrl;
            if (!mediaUrl) return;
            const contentType = (item.contentType || '').toLowerCase();
            if (contentType.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = mediaUrl;
              img.alt = item.filename || 'Immagine';
              img.loading = 'lazy';
              img.onclick = () => window.open(mediaUrl, '_blank');
              mediaWrapper.appendChild(img);
            } else {
              const link = document.createElement('a');
              link.href = mediaUrl;
              link.target = '_blank';
              link.rel = 'noopener noreferrer';
              link.textContent = item.filename || item.contentType || 'Allegato';
              mediaWrapper.appendChild(link);
            }
          });
          div.appendChild(mediaWrapper);
        }

        const tsDiv = document.createElement('div');
        tsDiv.className = 'timestamp';
        const timeSpan = document.createElement('span');
        timeSpan.textContent = formatTime(m.timestamp);
        tsDiv.appendChild(timeSpan);

        if (statusHtml) {
          const statusSpan = document.createElement('span');
          statusSpan.className = 'status-icon';
          statusSpan.innerHTML = statusHtml;
          tsDiv.appendChild(statusSpan);
        }

        div.appendChild(tsDiv);
        row.appendChild(div);
        box.appendChild(row);
      });

      box.scrollTop = box.scrollHeight;
    }

    function handleKey(e) {
      if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
      const input = document.getElementById('msgInput');
      const body = input.value.trim();
      if (!selectedConv || !body) return;

      const conv = conversations[selectedConv] || {};
      const number = (conv.phone || '').replace('whatsapp:', '');
      if (!number) return;
      const optimistic = normalizeMessage({
        text: body,
        direction: 'outbound',
        timestamp: Date.now()
      }) || { text: body, direction: 'outbound', timestamp: Date.now() };
      optimistic.__optimistic = true;
      if (!messagesByConv[selectedConv]) messagesByConv[selectedConv] = [];
      messagesByConv[selectedConv].push(optimistic);
      if (messagesByConv[selectedConv].length > 500) {
        messagesByConv[selectedConv].splice(0, messagesByConv[selectedConv].length - 500);
      }
      if (!conversations[selectedConv]) conversations[selectedConv] = {};
      conversations[selectedConv].lastMessageText = body;
      conversations[selectedConv].lastMessageAt = optimistic.timestamp;
      renderSidebar();
      renderConversation(selectedConv);

      try {
        const response = await fetch('/send', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ to: number, body, conversationId: selectedConv })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || `HTTP ${response.status}`);
        }

        const payload = await response.json().catch(() => ({}));
        input.value = '';
        if (payload?.sid) {
          optimistic.sid = payload.sid;
          if (!conversationStatuses[selectedConv]) conversationStatuses[selectedConv] = {};
          conversationStatuses[selectedConv][payload.sid] = {
            status: (payload.status || 'queued').toLowerCase()
          };
        }
        if (payload?.conversationId && !selectedConv) {
          selectedConv = payload.conversationId;
        }
      } catch (err) {
        console.error('Errore invio messaggio:', err);
        optimistic.status = 'failed';
        optimistic.errorMessage = 'Invio non riuscito';
        optimistic.__optimistic = false;
        if (!conversationStatuses[selectedConv]) conversationStatuses[selectedConv] = {};
        conversationStatuses[selectedConv][optimistic.sid || `optimistic-${optimistic.timestamp}`] = {
          status: 'failed'
        };
        renderConversation(selectedConv);
        alert('Invio non riuscito. Controlla il numero e riprova.');
      }
    }

    function handleFileChange(e) {
      const files = e.target.files;
      if (!files || !files.length) return;
    }

    function filterChats() {
      const inputEl = document.getElementById('searchInput');
      if (!inputEl) return;
      const term = inputEl.value.trim();
      searchState.term = term;

      if (searchState.debounce) {
        clearTimeout(searchState.debounce);
        searchState.debounce = null;
      }

      if (!term) {
        searchState.lastRequestId += 1;
        searchState.resultIds = [];
        renderSidebar(true);
        return;
      }

      searchState.debounce = setTimeout(() => {
        runSearch(term);
      }, 250);
    }

    function handleUnreadToggle() {
      renderSidebar(true);
    }

    async function runSearch(term) {
      const currentRequestId = ++searchState.lastRequestId;
      try {
        const response = await fetch(`/conversations/search?term=${encodeURIComponent(term)}&limit=200`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const list = await response.json();
        if (currentRequestId !== searchState.lastRequestId) return;
        const ids = [];
        if (Array.isArray(list)) {
          list.forEach(conv => {
            if (conv && conv.id) {
              conversations[conv.id] = { ...(conversations[conv.id] || {}), ...conv };
              ids.push(conv.id);
            }
          });
        }
        searchState.resultIds = ids;
      } catch (err) {
        if (currentRequestId === searchState.lastRequestId) {
          searchState.resultIds = [];
        }
        console.error('Errore durante la ricerca conversazioni:', err);
      } finally {
        if (currentRequestId === searchState.lastRequestId) {
          renderSidebar(true);
        }
      }
    }

    document.getElementById('chatList').addEventListener('scroll', (e) => {
      if (searchState.term) return;
      const el = e.target;
      if (el.scrollTop + el.clientHeight >= el.scrollHeight - 50) {
        const total = Object.keys(conversations || {}).length;
        if (conversationsPageSize < total) {
          conversationsPageSize += 50;
          renderSidebar(true);
        }
      }
    });

    function stopPollingFallback() {
      if (pollingTimer) {
        clearInterval(pollingTimer);
        pollingTimer = null;
      }
    }

    function startPollingFallback() {
      if (pollingTimer) return;
      pollingTimer = setInterval(() => {
        refreshData();
      }, POLLING_INTERVAL_MS);
    }

    function stopRealtimeUpdates() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
      stopPollingFallback();
    }

    function startRealtimeUpdates() {
      stopRealtimeUpdates();
      if (typeof EventSource === 'undefined') {
        startPollingFallback();
        return;
      }

      eventSource = new EventSource('/events');
      eventSource.onopen = () => {
        stopPollingFallback();
      };

      eventSource.onmessage = (event) => {
        if (!event.data) return;
        try {
          const payload = JSON.parse(event.data);
          handleServerEvent(payload);
        } catch (err) {
          console.error('Errore parsing SSE:', err);
        }
      };

      eventSource.onerror = () => {
        console.warn('Connessione SSE persa, attivo polling di fallback.');
        startPollingFallback();
      };
    }

    async function refreshData(targetConversationId) {
      try {
        await loadAll();
        const conversationToReload = targetConversationId || selectedConv;
        if (conversationToReload) {
          delete messagesByConv[conversationToReload];
          delete conversationStatuses[conversationToReload];
          const li = document.querySelector(`.chat-list li[data-conversation-id="${conversationToReload}"]`);
          if (li) {
            await loadChat(conversationToReload, li);
          }
        }
      } catch (err) {
        console.error('Errore durante il refresh automatico:', err);
      }
    }

    function handleServerEvent(eventPayload) {
      if (!eventPayload || !eventPayload.type) return;
      const { type } = eventPayload;
      if (type === 'message') {
        applyMessageEvent(eventPayload);
      } else if (type === 'status') {
        applyStatusEvent(eventPayload);
      } else if (type === 'summary') {
        applySummaryEvent(eventPayload);
      }
    }

    function applySummaryEvent({ conversationId, summary }) {
      if (!conversationId || !summary) return;
      conversations[conversationId] = { ...(conversations[conversationId] || {}), ...summary };
      renderSidebar();
    }

    function applyMessageEvent({ conversationId, summary, message, phone }) {
      if (!conversationId) return;
      if (summary) {
        conversations[conversationId] = { ...(conversations[conversationId] || {}), ...summary };
        renderSidebar();
      } else if (message) {
        const existing = conversations[conversationId] || {};
        conversations[conversationId] = {
          ...existing,
          phone: existing.phone || phone || conversationId,
          lastMessageText: message.text || existing.lastMessageText || '',
          lastMessageAt: message.timestamp || existing.lastMessageAt || Date.now()
        };
        if (message.direction === 'inbound') {
          conversations[conversationId].unreadCount = (conversations[conversationId].unreadCount || 0) + 1;
        }
        renderSidebar();
      }
      if (message) {
        mergeIncomingMessage(conversationId, message);
      }
    }

    function mergeIncomingMessage(conversationId, rawMessage) {
      const normalized = normalizeMessage(rawMessage);
      if (!normalized) return;
      const list = messagesByConv[conversationId];
      if (!list) return;

      if (normalized.direction === 'outbound') {
        const idx = list.findIndex(m => m.__optimistic && !m.sid && Math.abs((m.timestamp || 0) - (normalized.timestamp || 0)) < 2000 && (m.text || '') === (normalized.text || ''));
        if (idx >= 0) {
          list[idx] = { ...list[idx], ...normalized, __optimistic: false };
        } else {
          list.push(normalized);
        }
      } else {
        list.push(normalized);
      }

      list.sort((a, b) => a.timestamp - b.timestamp);
      if (list.length > 500) {
        list.splice(0, list.length - 500);
      }
      if (selectedConv === conversationId) {
        renderConversation(conversationId);
      }
    }

    function applyStatusEvent({ conversationId, sid, status, errorCode, errorMessage, timestamp }) {
      if (!conversationId || !sid) return;
      if (!conversationStatuses[conversationId]) conversationStatuses[conversationId] = {};
      conversationStatuses[conversationId][sid] = {
        sid,
        status,
        errorCode: errorCode || null,
        errorMessage: errorMessage || null,
        timestamp: timestamp || Date.now()
      };
      if (selectedConv === conversationId) {
        renderConversation(conversationId);
      }
    }

    function markUnread(conversationId, event) {
      if (event) event.stopPropagation();
      if (!conversationId) return;

      fetch('/mark-unread', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ conversationId, unreadCount: 1 })
      }).then(res => {
        if (!res.ok) return;
        if (!conversations[conversationId]) {
          conversations[conversationId] = { unreadCount: 1 };
        } else {
          conversations[conversationId].unreadCount = 1;
        }
        renderSidebar();
      });
    }

    function deleteChat(conversationId, event) {
      if (event) event.stopPropagation();
      if (!confirm('Sei sicuro di voler cancellare questa conversazione?')) return;

      fetch('/delete-chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ conversationId })
      })
      .then(res => {
        if (res.ok) {
          alert('Chat cancellata con successo');
          loadAll();
        } else {
          alert('Errore durante la cancellazione della chat');
        }
      });
    }
  </script>
</body>
</html>
